<!DOCTYPE html>
<html>
<head>
	<title>Elm image annotation demo</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>html, body, .style-elements { height: 100% }</style>
	<script src="Main.js"></script>
	<script src="elm-pep.js"></script>
</head>
<body>
	<script charset="utf-8">
		const layoutViewportSize = () => ({
			width: document.documentElement.clientWidth,
			height: document.documentElement.clientHeight
		})
		const app = Elm.Main.fullscreen( layoutViewportSize() )
		
		window.addEventListener( 'resize', () => app.ports.resizes.send( layoutViewportSize() ) )
		
		app.ports.loadImageFile.subscribe( pair => {
			const id = pair[0]
			const file = pair[1]
			if ( file.type.match( /image.*/ ) ) {
				sendLoadedImage( id, file, app.ports.imageLoaded )
			}
		})

		function sendLoadedImage( id, imageFile, outPort ) {
			const img = document.createElement( "img" )
			img.onload = () => outPort.send(
				{id: id, url: img.src, width: img.width, height: img.height}
			)
			img.src = window.URL.createObjectURL( imageFile )
		}

		app.ports.loadConfigFile.subscribe( (file) => {
			if ( file.type === "application/json" ) {
				sendLoadedConfig( file, app.ports.configLoaded )
			}
		})

		function sendLoadedConfig( configFile, outPort ) {
			const fileReader = new FileReader()
			fileReader.onload = () => outPort.send( fileReader.result )
			fileReader.readAsText( configFile )
		}

		app.ports.export.subscribe( (value) => {
			download( JSON.stringify( value ), "annotations.json", "application/json" )
		})

		// Download a file through an href temporary DOM element. see ref at:
		// http://stackoverflow.com/a/30832210/4822734
		// and FileSaver inspiration for click:
		// https://github.com/eligrey/FileSaver.js/blob/4ac2c6d6c286ea5e57e4098c58b33bfe9ec26f05/FileSaver.js#L29
		// example use:
		// download( str, "selection.json", "text/plain" )
		function download( data, name, data_type ) {
			const a = document.createElement("a")
			const data_file = new Blob( [data], {type: data_type} )
			a.addEventListener( 'click', (event) => {
				a.href = window.URL.createObjectURL( data_file )
				a.download = name
			})
			const click = (node) => {
				const event = new MouseEvent( "click" )
				node.dispatchEvent( event )
			}
			click( a )
		}
	</script>
</body>
</html>
